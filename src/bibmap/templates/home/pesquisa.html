{% load static %} {% include 'header.html' %}
<main role="main">
    <div class="container" style="margin-top:5em">
        <h1 class="display-5">Pesquisa avançada</h1>
        <hr/>
        <form id="formpesquisar" action="{%url 'home:Pesquisar' 1%}">
            <div class="card">
                <div class="card-content">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <h5 class="card-title">Dados a pesquisar:</h5>
                            </div>
                        </div>
                        <input type="hidden" value="" name="lat" id="inputlat">
                        <input type="hidden" value="" name="lng" id="inputlng">
                        <div class="row">
                            <div class="col-sm">
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroup-sizing-default">Pesquisa por
											nome</span>
                                    </div>
                                    <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default" name="search" value="{{parameters.search}}">
                                </div>
                            </div>
                            <div class="col-sm">
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroup-sizing-default">Mostrar
											apenas:</span>
                                    </div>
                                    <select class="custom-select" name="resultados" id="inputGroupSelect01">
										<option {%if parameters.mostrar == "all"%} selected{%endif%} value="all">
											Bibliotecas e Livros
										</option>
										<option {%if parameters.mostrar == "bibs"%} selected{%endif%} value="bibs">
											Biblioteca
										</option>
										<option {%if parameters.mostrar == "livros"%} selected{%endif%} value="livros">
											Livros
										</option>
									</select>
                                </div>
                            </div>
                            <div class="col-sm">
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroup-sizing-default">Pesquisar por
											cep</span>
                                    </div>
                                    <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default" value="{{parameters.cep}}" name="cep">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm">
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroup-sizing-default">Pesquisar por
											Autor</span>
                                    </div>
                                    <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default" value="{{parameters.filtroAutor}}" name="autor">
                                </div>
                            </div>
                            <div class="col-sm">
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroup-sizing-default">Pesquisar por
											ISBN:</span>
                                    </div>
                                    <input type="text" class="form-control" value="{{parameters.pesquisa_isbn}}" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default" name="isbn">
                                </div>
                            </div>
                            <div class="col-sm">
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroup-sizing-default">Filtrar por
											distância</span>
                                    </div>
                                    <input type="number" min="0" class="form-control" value="{{parameters.max_dist}}" id="distanciainput" name="distanciainput" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default" placeholder="km">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check">
                                    <input class="form-check-input" {%if parameters.somente_associados%} checked{%endif%} type="checkbox" value="True" id="apenas_livros" name="associados">
                                    <label class="form-check-label" for="apenas_livros">
										Mostrar apenas livros em bibliotecas
									</label>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-12">
                                        <h5 class="card-title">Filtrar bibliotecas:</h5>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" {%if parameters.independente%} checked{%endif%} type="checkbox" value="True" id="independente" name="independente">
                                            <label class="form-check-label" for="independente">
												Independentes
											</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" {%if parameters.acervo_proprio%} checked{%endif%} type="checkbox" value="True" id="aquisicao_acervo" name="acervo_proprio">
                                            <label class="form-check-label" for="aquisicao_acervo">
												Acervo Próprio
											</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" {%if parameters.aberta_a_comunidade%} checked{%endif%} type="checkbox" value="True" id="aberto_a_comunidade" name="aberta_a_comunidade">
                                            <label class="form-check-label" for="aberto_a_comunidade">
												Aberta a comunidade
											</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" {%if parameters.emprestimos%} checked{%endif%} type="checkbox" value="True" id="empresta_livro" name="emprestimos">
                                            <label class="form-check-label" for="empresta_livro">
												Empresta livros
											</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">

                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" {%if parameters.computadores%} checked{%endif%} type="checkbox" value="True" id="computador" name="computadores">
                                            <label class="form-check-label" for="computador">
												Computadores
											</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" {%if parameters.ac%} checked{%endif%} type="checkbox" value="True" id="ar_condicionado" name="ac">
                                            <label class="form-check-label" for="ar_condicionado">
												Ar-condicionado
											</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" {%if parameters.mesa_de_estudo%} checked{%endif%} type="checkbox" value="True" id="mesa_de_estudo" name="mesa_de_estudo">
                                            <label class="form-check-label" for="mesa_de_estudo">
												Mesas de estudo
											</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" {%if parameters.wifi%} checked{%endif%} type="checkbox" value="True" id="wifi" name="wifi">
                                            <label class="form-check-label" for="wifi">
												Wi-Fi
											</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row" style="float: right; margin:0 0 1em 0">
                            <button class="btn btn-info" type="submit"><i class="fa fa-search"></i> Pesquisar</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        {% if resultados_bibs or resultado_livros %}
        <div class="row" style="margin-top: 1em;">
            <div class="col-sm-3">
                <section class="card" style="margin-bottom: 1em; margin-top: 5px">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <h6 class="nav-link" style="margin: 0.5em 0 0 0">Filtar por:</h6>
                        </li>

                        {%if resultados_bibs%}

                        <li class="nav-item">
                            <a class="nav-link active" id="tabibs" href="#">Bibliotecas</a>
                        </li>
                        {% endif %} {% if resultado_livros %}
                        <li class="nav-item">
                            <a class="nav-link" id="tablivros" href="#">Livros</a>
                        </li>
                        {%endif%}

                    </ul>
                </section>
                {%if autores%}
                <section class="card" id="sectionautores" style="padding: 1em;">
                    <h6>Filtar por autor</h6>
                    {%for autor in autores%}
                    <a href="#" class="autor">{{autor}}</a> {%endfor%}
                </section>
                {%endif%}
            </div>
            {%if resultado_livros%}
            <div class="col-sm-9 {%if resultados_bibs%} d-none{%endif%}" id="resultado_livros" style="margin-bottom: 1em;">
                <div class="row" style="column-count: 1;">
                    {%for livro in resultado_livros%}
                    <div class="card" style="width: 271px; padding: 0.1em; margin: 5px">
                        <a href="{%url 'home:visualizarLivro' livro.id_livro%}">
                            <img src="{{livro.capa}}" class="card-img-top" alt="Sem capa" style="padding: 1em 1em 0 1em;">
                        </a>
                        <div class="card-body">
                            <h6 class="card-title" style="height: auto"><a href="{%url 'home:visualizarLivro' livro.id_livro%}">{{livro.nome}}</a></h6>
                            <p class="card-text text-muted">
                                {% for autor in livro.autores %} {{autor}} {% if forloop.counter == livro.autores|length%}{%else%},&nbsp;{%endif%} {% endfor %}
                            </p>
                            <p class="card-text">
                                {% if livro.id_menor %}
                                <a href="{%url 'home:visualizarBiblioteca' livro.id_menor%}">
										Disponível à: {{livro.distancia}} km</a> <br/> e em outras {{livro.quant_disponivel}} bibliotecas {% else %} Disponível em {{livro.quant_disponivel}} biblioteca{{livro.quant_disponivel|pluralize}} {% endif %}
                            </p>
                        </div>
                    </div>
                    {%endfor%}
                </div>
            </div>
            {%endif%} {%if resultados_bibs%}
            <div class="col-sm-9" id="resultado_bibs" style="margin-bottom: 1em;">
                <div class="row" style="column-count: 1;">
                    {% for biblioteca in resultados_bibs %}
                    <div class="card" style="width: 270px; padding: 0.1em; height: auto; margin: 5px">
                        <a href="{% url 'home:visualizarBiblioteca' biblioteca.id_bib %}">
                            <div style="background-image: url({{biblioteca.foto}}); background-size: cover; height: 200px; width: 200; background-position: center; margin: 1em 1em 0 1em"></div>
                        </a>
                        <div class="card-body">
                            <h5 class="card-title" style="height: 35px"> <a href="{% url 'home:visualizarBiblioteca' biblioteca.id_bib %}">{{ biblioteca.nome }}</a> </h5>
                            <p class="card-text text-muted">
                                {%if biblioteca.distancia%}
                                <p class="text-muted">{{biblioteca.distancia}} km de você </p>
                                {%endif%}
                            </p>
                            <p class="card-text">{{biblioteca.endereco}}</p>

                        </div>
                    </div>

                    {% endfor %}
                </div>
            </div>
            {%endif%}
        </div>
        {% endif %}
        <div class="row">
            {% if hasprev %}
            <div class="col-9">
                <a class="btn-sm btn-primary" href="{%url 'home:Pesquisar' prevpage%}?{{request.GET.copy.urlencode}}">Anterior</a>
            </div>
            {% else %}
            <div class="col-md-9"></div>
            {% endif %} {% if hasnext %}
            <div class="col-2">
                <a class="btn-sm btn-primary" href="{%url 'home:Pesquisar' nextpage%}?{{request.GET.copy.urlencode}}">Próximo</a>
            </div>
            {%endif%}
        </div>

    </div>
</main>
{% include 'footer.html' %}
<script>
    var showed = false;
    $("#distanciainput").focus(function() {
        if (showed == false) {
            alert("Para filtrar por distância você precisa nos fornecer a sua localização");
        }
        showed = true;

    });
    $(document).ready(function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                $("#inputlat").val(pos.lat);
                $("#inputlng").val(pos.lng);
                var inputdistancia = $("#distanciainput");
            });


        }
    });
    $(".autor").click(function(event) {
        event.stopPropagation();
        event.stopImmediatePropagation();
        event.preventDefault();
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('autor', this.text);
        window.location.search = urlParams.toString();
    });

    $(".autorlivro").click(function(event) {
        event.stopPropagation();
        event.stopImmediatePropagation();
        event.preventDefault();
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('autor', this.text);
        urlParams.set('search', '');
        urlParams.set('resultados', 'livros');


        window.location.search = urlParams.toString();
    })


    $("#tablivros").click(function(event) {
        event.stopImmediatePropagation();
        event.stopPropagation();
        event.preventDefault();
        if (typeof $("#resultado_livros") != 'undefined' && $("#resultado_livros").hasClass("d-none") && typeof $("#resultado_bibs") != 'undefined') {
            var resultado_livros = $("#resultado_livros");
            var resultado_bib = $("#resultado_bibs");
            resultado_bib.fadeOut(600, function() {
                resultado_bib.addClass("d-none");
                resultado_livros.removeClass("d-none");
                resultado_livros.fadeIn(600);
            });
        }
    });

    $("#tabibs").click(function(event) {
        event.stopImmediatePropagation();
        event.stopPropagation();
        event.preventDefault();
        if (typeof $("#resultado_livros") != 'undefined' && $("#resultado_bibs").hasClass("d-none") && typeof $("#resultado_bibs") != 'undefined') {
            var resultado_livros = $("#resultado_livros");
            var resultado_bib = $("#resultado_bibs");
            resultado_livros.fadeOut(600, function() {
                resultado_livros.addClass("d-none");
                resultado_bib.removeClass("d-none");
                resultado_bib.fadeIn(600);
            });
        }
    });
</script>
</body>

</html>